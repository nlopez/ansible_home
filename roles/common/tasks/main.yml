---
- name: Install common packages
  package:
    name:   "{{ common_packages }}"
    state: present

- name: Determine path to bash
  shell: which bash
  register: which_bash
  changed_when: False

- set_fact:
    bash_binary: "{{ which_bash.stdout | default('/usr/bin/bash') }}"

- name: Add Nick's group
  group:
    name: nlopez
    state: present

- name: Add Nick's superuser
  user:
    name: nlopez
    shell: "{{ bash_binary }}"
    group: nlopez
    groups: "{{ sudo_group }}"
    createhome: True

- name: Enumerate available groups
  shell: getent group | awk -F":" '{print $1}'
  register: etc_group
  changed_when: False

- name: Add Nick to docker group
  user:
    name: nlopez
    groups: docker
    append: yes
  when: "'docker' in etc_group.stdout_lines"

- name: Setup Nick's keys
  authorized_key:
    user: nlopez
    key: https://github.com/nlopez.keys
    exclusive: yes
    validate_certs: yes

- name: Allow members of sudoers group to run all commands without a password
  template:
    src: sudoers.j2
    dest: "{{ sudoers }}"
    validate: 'visudo -cf %s'
