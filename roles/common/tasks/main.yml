---
- name: Install common packages
  package: name="{{ item }}" state=present
  with_items:
    - bash
    - sudo
    - rsync
    - "{{ system_certificates }}"
    - curl
    - wget
    - mosh
    - screen
    - "{{ dig }}"
    - tree
    - "{{ vim }}"
    - pv
    - tcpdump

- name: Determine path to bash
  shell: which bash
  register: which_bash
  changed_when: False

- set_fact:
    bash_binary: "{{ which_bash.stdout | default('/usr/bin/bash') }}"

- name: Add Nick's group
  group: name=nlopez state=present

- name: Add Nick's superuser
  user:
    name: nlopez
    shell: "{{ bash_binary }}"
    group: nlopez
    groups: "{{ sudo_group }}"
    createhome: True

- name: Enumerate available groups
  shell: getent group | awk -F":" '{print $1}'
  register: etc_group
  changed_when: False

- name: Add Nick to docker group
  user: name=nlopez groups="{{ item }}" append=yes
  when: item in etc_group.stdout_lines
  with_items:
    - docker

- name: Setup Nick's keys
  authorized_key:
    user: nlopez
    key: https://github.com/nlopez.keys
    exclusive: yes
    validate_certs: yes # default

- name: Allow members of sudoers group to run all commands without a password
  template: src=sudoers.j2 dest={{ sudoers }} validate='visudo -cf %s'

